{"version":3,"sources":["../src/index.js"],"names":["app","server","http","createServer","use","exposedHeaders","config","corsHeaders","bodyParser","json","limit","bodyLimit","secret","sessionSecret","resave","saveUninitialized","projectName","express","static","path","join","__dirname","jwtSecret","algorithms","credentialsRequired","getToken","req","util","isNothing","headers","token","requestProperty","unless","url","methods","err","res","next","name","status","code","msg","db","listen","process","env","PORT","port","console","log","address"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,IAAIA,MAAM,wBAAV;AACAA,IAAIC,MAAJ,GAAaC,eAAKC,YAAL,CAAkBH,GAAlB,CAAb;;AAEA;;AAEAA,IAAII,GAAJ,CAAQ,oBAAK;AACZC,iBAAgBC,iBAAOC;AADX,CAAL,CAAR;;AAIAP,IAAII,GAAJ,CAAQI,qBAAWC,IAAX,CAAgB;AACvBC,QAAQJ,iBAAOK;AADQ,CAAhB,CAAR;;AAIAX,IAAII,GAAJ,CAAQ,8BAAe;AACtBQ,SAAQN,iBAAOO,aADO;AAEtBC,SAAQ,KAFc;AAGtBC,oBAAmB;AAHG,CAAf,CAAR;;AAMAf,IAAII,GAAJ,CAAQ,MAAME,iBAAOU,WAArB,EAAkCC,kBAAQC,MAAR,CAAeC,eAAKC,IAAL,CAAUC,SAAV,EAAqB,OAArB,CAAf,CAAlC;;AAEArB,IAAII,GAAJ,CAAQ,0BAAW;AAClBQ,SAAQN,iBAAOgB,SADG;AAElBC,aAAY,CAAC,OAAD,CAFM;AAGlBC,sBAAqB,IAHH;AAIlBC,SAJkB,oBAIRC,GAJQ,EAIH;;AAEd,SAAOC,eAAKC,SAAL,CAAeF,IAAIG,OAAJ,CAAYC,KAA3B,IAAoC,IAApC,GAA2CJ,IAAIG,OAAJ,CAAYC,KAA9D;AACA,EAPiB;;AAQlBC,kBAAiB;AARC,CAAX,EASLC,MATK,CASE;AACTb,OAAM,CACL;AACCc,OAAK,kHADN;AAECC,WAAS,CAAC,KAAD,EAAQ,MAAR;AAFV,EADK,EAKL;AACCD,OAAK,sGADN;AAECC,WAAS,CAAC,KAAD,EAAQ,MAAR;AAFV,EALK;AADG,CATF,CAAR;;AAsBAlC,IAAII,GAAJ,CAAQ,UAAC+B,GAAD,EAAMT,GAAN,EAAWU,GAAX,EAAgBC,IAAhB,EAAyB;;AAEhC,KAAIF,IAAIG,IAAJ,KAAa,mBAAjB,EAAsC;AACrCF,MAAIG,MAAJ,CAAW,GAAX,EAAgB9B,IAAhB,CAAqB;AACpB+B,SAAM,GADc;AAEpBC,QAAK;AAFe,GAArB;AAIA;AACD,CARD;;AAUA,kBAAc,cAAM;;AAEnBzC,KAAII,GAAJ,CAAQ,0BAAW,EAAEE,wBAAF,EAAUoC,MAAV,EAAX,CAAR;;AAEA1C,KAAII,GAAJ,CAAQ,MAAME,iBAAOU,WAArB,EAAkC,mBAAI,EAAEV,wBAAF,EAAUoC,MAAV,EAAJ,CAAlC;;AAEA1C,KAAIC,MAAJ,CAAW0C,MAAX,CAAkBC,QAAQC,GAAR,CAAYC,IAAZ,IAAoBxC,iBAAOyC,IAA7C,EAAmD,YAAM;AACxDC,UAAQC,GAAR,sBAA+BjD,IAAIC,MAAJ,CAAWiD,OAAX,GAAqBH,IAApD;AACA,EAFD;AAGA,CATD;;kBAWe/C,G","file":"index.js","sourcesContent":["import http from 'http'\nimport path from 'path'\nimport express from 'express'\nimport cors from 'cors'\nimport morgan from 'morgan'\nimport bodyParser from 'body-parser'\nimport expressSession from 'express-session'\nimport expressJWT from 'express-jwt'\nimport initializeDb from './db'\nimport middleware from './middleware'\nimport api from './api'\nimport config from './config.json'\nimport util from './lib/util'\n\nlet app = express()\napp.server = http.createServer(app)\n\n// app.use(morgan('dev'))\n\napp.use(cors({\n\texposedHeaders: config.corsHeaders\n}))\n\napp.use(bodyParser.json({\n\tlimit : config.bodyLimit\n}))\n\napp.use(expressSession({\n\tsecret: config.sessionSecret,\n\tresave: false,\n\tsaveUninitialized: true\n}))\n\napp.use('/' + config.projectName, express.static(path.join(__dirname, 'views')))\n\napp.use(expressJWT({\n\tsecret: config.jwtSecret,\n\talgorithms: [\"HS256\"],\n\tcredentialsRequired: true,\n\tgetToken (req) {\n\t\t\n\t\treturn util.isNothing(req.headers.token) ? null : req.headers.token\n\t},\n\trequestProperty: 'xiezn'\n}).unless({\n\tpath: [\n\t\t{\n\t\t\turl: /.*\\/(login|faceLogin|register|upload|download|resetPass|autoSort|list|sendemail|notify|update|security|sendsms)$/,\n\t\t\tmethods: ['GET', 'POST']\n\t\t},\n\t\t{\n\t\t\turl: /.*\\/(config|option|follow|sh|remind|cal|group|value|news|info|detail|forum|updateBrowseDuration)\\/.*/,\n\t\t\tmethods: ['GET', 'POST']\n\t\t}\n\t]\n}))\n\napp.use((err, req, res, next) => {\n\n\tif (err.name === 'UnauthorizedError') {\n\t\tres.status(200).json({\n\t\t\tcode: 401,\n\t\t\tmsg: '您的权限不够！'\n\t\t})\n\t}\n})\n\ninitializeDb( db => {\n\n\tapp.use(middleware({ config, db }))\n\n\tapp.use('/' + config.projectName, api({ config, db }))\n\n\tapp.server.listen(process.env.PORT || config.port, () => {\n\t\tconsole.log(`Started on port ${app.server.address().port}`)\n\t})\n})\n\nexport default app\n"]}